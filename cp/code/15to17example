# 13: SDEs ----

 if (!quietly)
   cat(sprintf(
     "[%s] Exclude same day extraneous...\n",
     Sys.time()
   ))

 # prepare a list of valid rows and initialize variables for convenience
 valid.rows <- valid(data.df, include.temporary.extraneous = TRUE) &
   !data.df$nnte_full  # does not use the "other"

 data.df <- data.df[valid.rows, exclude := (function(subj_df) {
   # keep the original indices and exclude to overwrite
   orig_idx <- copy(subj_df$index)
   exclude_all <- copy(subj_df$exclude)
   if (nrow(subj_df) > 0 & any(subj_df$exclude == "Exclude-Temporary-Extraneous-Same-Day")){
     # for convenience
     subj_df[, extraneous := exclude == "Exclude-Temporary-Extraneous-Same-Day"]

     step <- "Exclude-SDE-Identical"

     # identify duplicate days
     dup_days <- unique(subj_df$agedays[subj_df$extraneous])

     # first, exclude identical measurements on the same day
     ide_ids <- c() # where we keep the identical ones
     for (dd in dup_days){
       # count amount of unique values
       s_df <- copy(subj_df[subj_df$agedays == dd,])
       ide_tab <- table(s_df$v)
       if (any(ide_tab > 1)){
         # for each identical, keep only the first one, by id
         # (ordered initially)
         ide_ids <- c(ide_ids, s_df$index[
           as.character(s_df$v) %in% names(ide_tab[ide_tab > 1])
         ][duplicated(
           s_df$v[
             as.character(s_df$v) %in% names(ide_tab[ide_tab > 1])
           ]
         )])
       }
     }
     criteria <- subj_df$index %in% ide_ids

     # we're going to update excludes before moving on to the rest of this
     # subject
     exclude_all[criteria] <- step

     subj_df <- subj_df[!criteria,]

     if (any(criteria)){
       # reevaluate temp same day
       subj_df[, extraneous := temporary_extraneous_infants(subj_df)]

       # identify duplicate days
       dup_days <- unique(subj_df$agedays[subj_df$extraneous])
     }

     # 13B: identify similar groups
     similar_ids <- c()
     for (dd in dup_days){
       # first, calculate if all SDEs on a single day are similar
       s_df <- copy(subj_df[subj_df$agedays == dd,])

       similar <- if (subj_df$param[1] == "WEIGHTKG"){
         max(s_df$v)/min(s_df$v) <= 1.03 & max(s_df$v) - min(s_df$v) <= 2.5
       } else if (subj_df$param[1] == "HEIGHTCM"){
         (max(s_df$v) - min(s_df$v) <  2.541 & min(s_df$v) < 127) |
           (max(s_df$v) - min(s_df$v) <  5.081 & min(s_df$v) >= 127)
       } else { # head circumference
         max(s_df$v) - min(s_df$v) <  1.271
       }

       if (similar){
         similar_ids <- c(similar_ids, s_df$index)
       }
     }

     # 13C: exclude non similar groups

     step <- "Exclude-SDE-All-Exclude"
     # now the rest!

     # next, calculate the duplicate ratio -- what proportion of days are
     # duplicated
     dup_ratio <-
       length(unique(subj_df$agedays[duplicated(subj_df$agedays)]))/
       length(unique(subj_df$agedays))
     # also check whether or not any same-days are adjacent -- need 4 at least
     # rolling windows of day differences -- we are looking for 0,x,0
     if (nrow(subj_df) > 3){
       roll <- embed(diff(subj_df$agedays), 3)
       adjacent <- sapply(1:nrow(roll), function(x){
         all(c(roll[x,1] == 0, roll[x,2] != 0, roll[x,3] == 0))
       })

       # get age days & rows that had adjacent
       idx_roll <- c(embed(1:nrow(subj_df),4)[adjacent,, drop = FALSE])
       idx_adj <- which(subj_df$agedays %in% subj_df$agedays[idx_roll])
     } else {
       adjacent <- FALSE
       idx_adj <- idx_roll <- c()
     }

     # if dup ratio is too high, we exclude all
     # if adjacent, we exclude only those relevant sdes
     # same day extraneous -- for strict (default)
     criteria <-
       # looser criteria:
       # 1.	Exclude for ratio if ratio >1/3
       # 2.	Exclude for adjacent if 2 are adjacent AND ratio >1/4
       # 3.	Exclude for adjacent if 2 are adjacent AND those 2 are the first 2 or last 2 measurements for the subject/parameter
       #   note: if the first or last is sde and it's adjacent, by default
       #   that means it's the first or last two that are adjacent
       # 4.	Exclude for adjacent if 3 or more are adjacent
       if (dup_ratio > (1/3)){
         subj_df$extraneous
       } else if (
         (sum(adjacent) == 1 & dup_ratio > (1/4)) |
         (sum(adjacent) == 1 & c(1) %in% idx_adj) |
         (sum(adjacent) == 1 &
          c(nrow(subj_df)) %in% idx_adj) |
         (sum(adjacent) >= 2)
       ){
         # adjacent sum == 1 means 2 are adjacent
         # only exclude sdes that are adjacent
         subj_df$agedays %in% subj_df$agedays[idx_roll]
       } else {
         rep(FALSE, nrow(subj_df))
       }
     # re-include similar groups
     criteria[subj_df$index %in% similar_ids] <- FALSE

     # we're going to update excludes before moving on to the rest of this
     # subject
     exclude_all[orig_idx %in% subj_df$index[criteria]] <- step

     subj_df <- subj_df[!criteria,]

     if (any(criteria)){
       # reevaluate temp same day
       subj_df[, extraneous := temporary_extraneous_infants(subj_df)]

       # identify duplicate days
       dup_days <- unique(subj_df$agedays[subj_df$extraneous])
     }

     step_extreme <- "Exclude-SDE-All-Extreme"
     step <- "Exclude-SDE-EWMA"
     # next, check for trivial differences for SDEs on the same day
     # this only works if there are non-sde days

     if (any(subj_df$extraneous)){
       # 13D: calculating ewmas

       # check for SDEs by EWMA -- alternate calculate excluding other SDEs
       all_sdes <- duplicated(subj_df$agedays) |
         duplicated(subj_df$agedays, fromLast = TRUE)

       # first, calculate which exponent we want to put through (pass a different
       # on for each exp)
       tmp <- data.frame(
         "before" = abs(subj_df$agedays - c(NA, subj_df$agedays[1:(nrow(subj_df)-1)])),
         "after" = abs(subj_df$agedays - c(subj_df$agedays[2:(nrow(subj_df))], NA))
       )
       maxdiff <- sapply(1:nrow(tmp), function(x){max(tmp[x,], na.rm = TRUE)})
       exp_vals <- rep(-1.5, nrow(tmp))
       exp_vals[maxdiff > 365.25] <- -2.5
       exp_vals[maxdiff > 730.5] <- -3.5
       subj_df[, exp_vals := exp_vals]

       # calculate the time difference for all values, as well as exponential
       delta <- as_matrix_delta(subj_df$agedays)
       delta <- ifelse(delta == 0, 0, (delta + 5) ^ subj_df$exp_vals)

       rem_ids_extreme <- c()
       rem_ids <- c()
       for (dd in dup_days){
         # first, calculate if all SDEs on a single day are similar
         s_df <- copy(subj_df[subj_df$agedays == dd,])

         similar <- if (subj_df$param[1] == "WEIGHTKG"){
           max(s_df$v)/min(s_df$v) < 1.03 & max(s_df$v) - min(s_df$v) < 2.5
         } else if (subj_df$param[1] == "HEIGHTCM"){
           (max(s_df$v) - min(s_df$v) <  2.541 & min(s_df$v) < 127) |
             (max(s_df$v) - min(s_df$v) <  5.081 & min(s_df$v) >= 127)
         } else { # head circumference
           max(s_df$v) - min(s_df$v) <  1.271
         }

         if (!similar){
           # 13E

           # calculate dewma for each SDE on this day
           dewma <- sapply(1:nrow(s_df), function(x){
             ind <- subj_df$index == s_df[[x, "index"]]

             ewma_res <- sum(subj_df$tbc.sd[!all_sdes]*delta[ind,!all_sdes])/
               sum(delta[ind, !all_sdes])

             # delta ewma
             return(s_df$tbc.sd[x] - ewma_res)
           })
           absdewma <- abs(dewma)

           if (min(absdewma) > 1){
             rem_ids_extreme <- c(rem_ids_extreme, s_df$index)
           } else {
             de_day <- which.min(abs(dewma))

             # keep the value with the lowest EWMA -- do not keep rest
             rem_ids <- c(rem_ids, s_df$index[-de_day])
           }
         }
         # re-include similar groups
         criteria_extreme <- subj_df$index %in% rem_ids_extreme
         criteria <- subj_df$index %in% rem_ids
       }
       # we're going to update excludes before moving on to the rest of this
       # subject
 #
 #          if (unique(df_sub$subjid) == "13001015" & unique(df_sub$param) == "HEIGHTCM") {
 # fwrite(df_sub, "../data/ewma_lead_NNNNN.csv")}


       exclude_all[orig_idx %in% subj_df$index[criteria_extreme]] <- step_extreme
       exclude_all[orig_idx %in% subj_df$index[criteria]] <- step

       subj_df <- subj_df[!(criteria | criteria_extreme),]

       if (any(c(criteria, criteria_extreme))){
         # reevaluate temp same day
         subj_df[, extraneous := temporary_extraneous_infants(subj_df)]

         # identify duplicate days
         dup_days <- unique(subj_df$agedays[subj_df$extraneous])
       }
     }

     # all remaining are similar
     step_extreme <- "Exclude-SDE-All-Extreme"
     step <- "Exclude-SDE-One-Day"

     if (any(subj_df$extraneous)){
       # check for SDEs
       all_sdes <- duplicated(subj_df$agedays) |
         duplicated(subj_df$agedays, fromLast = TRUE)

       rem_ids <- c()
       rem_ids_extreme <- c()
       for (dd in dup_days){
         # first, calculate if all SDEs on a single day are similar
         s_df <- copy(subj_df[subj_df$agedays == dd,])

         # find the DOP (designated other parameter)
         dop <-
           data.df[subjid == s_df$subjid[1] & param == get_dop(s_df$param[1]) &
                     agedays == s_df$agedays[1],]

         if (nrow(dop) > 0){
           # 13F
           med_diff <- abs(median(dop$tbc.sd)-s_df$tbc.sd)

           if (min(med_diff) > 2){
             rem_ids_extreme <- c(rem_ids_extreme, s_df$index)
           } else {
             de_day <- which.min(med_diff)

             # keep the value with the lowest median diff -- do not keep rest
             rem_ids <- c(rem_ids, s_df$index[-de_day])
           }
         } else if (nrow(s_df) > 3){
           #13G
           med_diff <- abs(median(s_df$tbc.sd)-s_df$tbc.sd)

           # if even and the middle two values are equidistant
           if (nrow(s_df)%%2 == 0 &
               diff(sort(med_diff)[1:2]) < 1e-8){
             # if the ageday is even, keep the lower z score; otherwise,
             # keep higher
             keep_val <-
               if (s_df$agedays[1]%%2 == 0){
                 which(s_df$v == min(s_df$v[order(med_diff)[1:2]]))
               } else {
                 which(s_df$v == max(s_df$v[order(med_diff)[1:2]]))
               }
             rem_ids <- c(rem_ids, s_df$index[-keep_val])
           }

           de_day <- which.min(med_diff)
           # keep the value with the lowest median diff -- do not keep rest
           rem_ids <- c(rem_ids, s_df$index[-de_day])
         } else {
           # 13H

           # 2 values, keep based on the age days
           keep_val <-
             if (s_df$agedays[1]%%2 == 0){
               which.min(s_df$v)
             } else {
               which.max(s_df$v)
             }
           rem_ids <- c(rem_ids, s_df$index[-keep_val])
         }
       }

       # re-include similar groups
       criteria_extreme <- subj_df$index %in% rem_ids_extreme
       criteria <- subj_df$index %in% rem_ids
       # we're going to update excludes before moving on to the rest of this
       # subject
       exclude_all[orig_idx %in% subj_df$index[criteria_extreme]] <- step_extreme
       exclude_all[orig_idx %in% subj_df$index[criteria]] <- step
     }
   }

   # replace all the "exclude temp extraneous" with includes -- other SDEs
   # were removed
   exclude_all[exclude_all == "Exclude-Temporary-Extraneous-Same-Day"] <-
     "Include"

   return(exclude_all)
 })(copy(.SD)), by = .(subjid, param), .SDcols = colnames(data.df)]

 # 15: moderate EWMA ----

 if (!quietly)
   cat(sprintf(
     "[%s] Exclude moderate EWMA...\n",
     Sys.time()
   ))

 # create the valid set
 # we only running carried forwards on valid values, non NNTE values,
 # and non single values, and non pair
 tmp <- table(paste0(data.df$subjid, "_", data.df$param))
 not_single_pairs <- paste0(data.df$subjid, "_", data.df$param) %in% names(tmp)[tmp > 2]
 valid_set <- valid(data.df, include.temporary.extraneous = FALSE) &
   !data.df$nnte_full & # does not use the "other"
   not_single_pairs

 # work in an a function order to encapsulate and not keep all the additional
 # columns

 # calculate plus/minus values
#    out_path <- "../data/sde_debug_NNNNN.csv"
#           data.table::fwrite(
#   data.df,
#   file = out_path,
#   append = file.exists(out_path),
#   col.names = !file.exists(out_path)
# )
 # order just for ease later
 data.df <- data.df[order(subjid, param, agedays),]
 data.df <- data.df[valid_set, exclude := (function(df) {
   # 15A: calc plus/minus values
   df[param == "WEIGHTKG", p_plus := 1.05*v]
   df[param == "WEIGHTKG", p_minus := .95*v]

   df[param == "HEIGHTCM", p_plus := v+1]
   df[param == "HEIGHTCM", p_minus := v-1]

   df[param == "HEADCM", p_plus := v+1]
   df[param == "HEADCM", p_minus := v-1]


   message("id before recenter: ", paste(head(df$id), collapse=", "))

   #15B: smooth and recenter
   df <- calc_and_recenter_z_scores(df, "p_plus", ref.data.path)
   df <- calc_and_recenter_z_scores(df, "p_minus", ref.data.path)
   message("id after recenter: ", paste(head(df$id), collapse=", "))

   #15c: exclude agedays = 0 for ht, hc
   #15d: calculate ewma -- run within a subject/parameter

    # print(df_sub)
  out_path <- "../data/sde_debug_NNNNN.csv"
         data.table::fwrite(
 data.df,
 file = out_path,
 append = file.exists(out_path),
 col.names = !file.exists(out_path)
)


   df[!((param == "HEIGHTCM" | param == "HEADCM") & agedays == 0),
      exclude := (function(df_sub) {
        # save initial exclusions to keep track
        ind_all <- copy(df_sub$index)
        exclude_all <- copy(df_sub$exclude)

        testing <- TRUE
        df_sub[, first_meas := FALSE]
        df_sub[agedays != 0 & seq_len(.N) == 1, first_meas := TRUE, by = .(subjid, param)]

        while (testing & nrow(df_sub) >= 3){
          df_sub[, (ewma.fields) := as.double(NaN)]

          # first, calculate which exponent we want to put through (pass a different
          # on for each exp)
          # subset df to only valid rows

          tmp <- data.frame(
            "before" = abs(df_sub$agedays - c(NA, df_sub$agedays[1:(nrow(df_sub)-1)])),
            "after" = abs(df_sub$agedays - c(df_sub$agedays[2:(nrow(df_sub))], NA))
          )
          maxdiff <- sapply(1:nrow(tmp), function(x){max(tmp[x,], na.rm = TRUE)})
          exp_vals <- rep(-1.5, nrow(tmp))
          exp_vals[maxdiff > 365.25] <- -2.5
          exp_vals[maxdiff > 730.5] <- -3.5
          df_sub[, exp_vals := exp_vals]

          # calculate ewma
          df_sub[, (ewma.fields) := ewma(agedays, tbc.sd, exp_vals, TRUE)]
          df_sub[, paste0("c.",ewma.fields) := ewma(agedays, ctbc.sd, exp_vals, TRUE)]

          # calculate dewma
          df_sub[, `:=`(
            dewma.all = tbc.sd - ewma.all,
            dewma.before = tbc.sd - ewma.before,
            dewma.after = tbc.sd - ewma.after,

            c.dewma.all = ctbc.sd - c.ewma.all
          )]

          # 15E: calculate prior and next differences
          df_sub[, tbc_diff_next := tbc.sd - c(tbc.sd[2:nrow(df_sub)], NA)]
          df_sub[, tbc_diff_prior := tbc.sd - c(NA, tbc.sd[1:(nrow(df_sub)-1)])]

          df_sub[, tbc_diff_plus_next := tbc.p_plus - c(tbc.sd[2:nrow(df_sub)], NA)]
          df_sub[, tbc_diff_plus_prior :=
                   tbc.p_plus- c(NA, tbc.sd[1:(nrow(df_sub)-1)])]

          df_sub[, tbc_diff_minus_next := tbc.p_minus - c(tbc.sd[2:nrow(df_sub)], NA)]
          df_sub[, tbc_diff_minus_prior :=
                   tbc.p_minus- c(NA, tbc.sd[1:(nrow(df_sub)-1)])]

          # 15F: all exclusion criteria
          df_sub[,
                 addcrithigh :=
                   dewma.before > 1 & dewma.after > 1 &
                   ((tbc_diff_next > 1 & tbc_diff_plus_next > 1 & tbc_diff_minus_next > 1) | is.na(tbc_diff_next)) &
                   ((tbc_diff_prior > 1 & tbc_diff_plus_prior > 1 & tbc_diff_minus_prior > 1) | is.na(tbc_diff_prior))
          ]
          df_sub[,
                 addcritlow :=
                   dewma.before < -1 & dewma.after < -1 &
                   ((tbc_diff_next < -1 & tbc_diff_plus_next < -1 & tbc_diff_minus_next < -1) | is.na(tbc_diff_next)) &
                   ((tbc_diff_prior < -1 & tbc_diff_plus_prior < -1 & tbc_diff_minus_prior < -1) | is.na(tbc_diff_prior))
          ]
#
# # --- Write EWMA2 diagnostics for all subjects/parameters ---

# ------------------------------------------------------------
                            # out_path <- "../data/sde_debug_NNNNN.csv"
#            print(df_sub)

         # check conditions before writing
         # if (unique(subj_df$subjid) == "3688") {

           # if file exists, append without column names
         #   if (file.exists(out_path)) {
         #     data.table::fwrite(df_sub, file = out_path, append = TRUE, col.names = FALSE)
         #   } else {
         #     # if not, write with header
         #     data.table::fwrite(df_sub, file = out_path)
         #   }
         # # }
          #15G: find all the values for the DOP
          # find the comparison -- making sure to keep only valid rows
          compare_df <- data.df[subjid == df_sub$subjid[1] &
                                  param == get_dop(df_sub$param[1]) &
                                  exclude == "Include",]
          if (nrow(compare_df) > 0){
            df_sub[compare_df, tbc_dop := i.tbc.sd,
                   on = c("agedays")]
            df_sub[is.na(tbc_dop), tbc_dop := median(compare_df$tbc.sd)]
          } else {
            df_sub[, tbc_dop := NA]
          }

          #15H: all exclusions
          df_sub$rowind <- 1:nrow(df_sub)


          ### CP HOTSWAP
          #a
          # df_sub[-c(1, nrow(df_sub)),][
          #   dewma.all > 1 & (c.dewma.all > 1 | is.na(c.dewma.all)) & addcrithigh == TRUE,
          #   exclude := "Exclude-EWMA2-middle"]
          # df_sub[-c(1, nrow(df_sub)),][
          #   dewma.all < -1 & (c.dewma.all < -1 | is.na(c.dewma.all)) & addcritlow,
          #   exclude := "Exclude-EWMA2-middle"]

          ### Version2:

           df_sub[
           dewma.all > 1 &
           (c.dewma.all > 1| is.na(c.dewma.all)) &
           addcrithigh == TRUE &
           !(seq_len(.N) %in% c(1, .N)),
           exclude := "Exclude-EWMA2-middle"
           ]

           df_sub[
           dewma.all < -1 &
           (c.dewma.all < -1 | is.na(c.dewma.all)) &
           addcritlow == TRUE &
           !(seq_len(.N) %in% c(1, .N)),
           exclude := "Exclude-EWMA2-middle"
           ]

          ### CP HOTSWAP U
#


          #b
          df_sub[agedays == 0 & agedays[2] < 365.25 &
                   dewma.all > 3 & (c.dewma.all > 3 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-birth-WT"]
          df_sub[agedays == 0 & agedays[2] < 365.25 &
                   dewma.all < -3 & (c.dewma.all < -3 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-birth-WT"]

          #c
          df_sub[agedays == 0 & agedays[2] >= 365.25 &
                   dewma.all > 4 & (c.dewma.all > 4 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-birth-WT-ext"]
          df_sub[agedays == 0 & agedays[2] >= 365.25 &
                   dewma.all < -4 & (c.dewma.all < -4 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-birth-WT-ext"]

          #d
          df_sub[first_meas & (dplyr::lead(agedays)-agedays < 365.25) &
                   dewma.all > 2 & (c.dewma.all > 2 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-first"]
          df_sub[first_meas & (dplyr::lead(agedays)-agedays < 365.25) &
                   dewma.all < -2 & (c.dewma.all < -2 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-first"]

          # e
          df_sub[first_meas & (dplyr::lead(agedays)-agedays) >= 365.25 &
                   dewma.all > 3 & (c.dewma.all > 3 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-first-ext"]
          df_sub[first_meas & (dplyr::lead(agedays)-agedays) >= 365.25 &
                   dewma.all < -3 & (c.dewma.all < -3 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-first-ext"]

          # f
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] < 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) < 2 &
                   dewma.all > 2 & (c.dewma.all > 2 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-last"]
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] < 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) < 2 &
                   dewma.all < -2 & (c.dewma.all < -2 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-last"]
                message("id in 15: ", paste(head(df$id), collapse=", "))

          # g
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] < 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) >= 2 &
                   dewma.all > abs(tbc.sd[nrow(df_sub)-1]) &
                   (c.dewma.all > 3 | is.na(c.dewma.all)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-last-high"]
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] < 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) >= 2 &
                   dewma.all < abs(tbc.sd[nrow(df_sub)-1]) &
                   (c.dewma.all < -3 | is.na(c.dewma.all)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-last-high"]

          # h
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] >= 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) < 2 &
                   dewma.all > 3 &
                   (c.dewma.all > 3 | is.na(c.dewma.all)) &
                   (tbc.sd - tbc_dop > 4 | is.na(tbc_dop)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-last-ext"]
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] >= 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) < 2 &
                   dewma.all < -3 &
                   (c.dewma.all <- 3 | is.na(c.dewma.all)) &
                   (tbc.sd - tbc_dop < -4 | is.na(tbc_dop)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-last-ext"]

          # i
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] >= 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) >= 2 &
                   dewma.all > (1+abs(tbc.sd[nrow(df_sub)-1])) &
                   (c.dewma.all > 3 | is.na(c.dewma.all)) &
                   (tbc.sd - tbc_dop > 4 | is.na(tbc_dop)) &
                   addcrithigh
                 , exclude := "Exclude-EWMA2-last-ext-high"]
          df_sub[rowind == nrow(df_sub) &
                   agedays[nrow(df_sub)]-agedays[nrow(df_sub)-1] >= 365.25*2 &
                   abs(tbc.sd[nrow(df_sub)-1]) >= 2 &
                   dewma.all < (-1-abs(tbc.sd[nrow(df_sub)-1])) &
                   (c.dewma.all <- 3 | is.na(c.dewma.all)) &
                   (tbc.sd - tbc_dop < -4 | is.na(tbc_dop)) &
                   addcritlow
                 , exclude := "Exclude-EWMA2-last-ext-high"]



          # figure out if any of the exclusions hit
          count_exclude <- sum(df_sub$exclude != "Include")
          if (count_exclude > 0){
            df_sub[, abssum := abs(tbc.sd + dewma.all)]

            # choose the highest abssum for exclusion
            idx <- df_sub$index[which.max(df_sub[df_sub$exclude != "Include",
                                                 abssum])]

            exclude_all[ind_all == idx] <- df_sub[index == idx, exclude]

            #set up to continue on
            testing <- TRUE

            df_sub <- df_sub[index != idx, ]
          } else {
            testing <- FALSE
          }
        }
         out_path <- "../data/step15_debug_NNNNN.csv"


        return(exclude_all)
      })(copy(.SD)), , by = .(subjid, param), .SDcols = colnames(df)]

   return(df$exclude)
 })(copy(.SD)), .SDcols = colnames(data.df)]
