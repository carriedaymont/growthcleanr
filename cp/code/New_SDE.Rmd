---
title: "R Notebook"
output: html_notebook
---


```{r}
#### Updates to temp sde and one days tiebreaking/decision matrix:

# Temp SDE:
# 1. Smallest absdiff from median of all values for POI on ageday of interest
# 2. Smallest absdiff from median of all values for DOP on ageday of interest
# 3. Highest obsid

# One days:
# 1. Smallest absdiff from median of all values for POI on ageday of interest
# 2. Smallest absdiff from median of all values for DOP on ageday of interest
# 3. Highest obsid

# EWMAs (Done in code)
# 1. Smallest absdewma
# 2. Highest obsid.

# SDE Ewma All-Extreme 
# 1. If min_absdewma is > 2 ~ "SDE-EWMA-All-Extreme"

```
### Helper Functions
```{r}
map_to_stata <- function(x) {
  case_when(
    # --- Carry-forward family ---
    x == "Exclude-1-CF-deltaZ-<0.05" ~ "1 CF deltaZ <0.05",
    x == "Exclude-1-CF-deltaZ-<0.1-wholehalfimp" ~ "1 CF imperial deltaZ <0.1",
    x == "Exclude-Teen-2-plus-CF-deltaZ-<0.05" ~ "Carried forward",
    x == "Exclude-Carried-Forward" ~ "Carried forward",

    # --- Measurement count flags ---
    x == "Exclude-1-meas" ~ "1 meas",
    x == "Exclude-2-meas-<1-year" ~ "2 meas <1 year",
    x == "Exclude-2-meas->1-year" ~ "2 meas >1 year",

    # --- Biologically implausible values ---
    x == "Exclude-Absolute-BIV" ~ "Absolute BIV",
    x == "Exclude-Standardized-BIV" ~ "Standardized BIV",

    # --- EWMA steps ---
    x == "Exclude-EWMA1-Extreme" ~ "EWMA1 high sum",
    x == "Exclude-EWMA2-middle" ~ "EWMA2 middle",
    x == "Exclude-EWMA2-first" ~ "EWMA2 first",
    x == "Exclude-EWMA2-first-ext" ~ "EWMA2 first ext",
    x == "Exclude-EWMA2-last" ~ "EWMA2 last",
    x == "Exclude-EWMA2-birth-HT-HC" ~ "EWMA2 birth HT HC",
    x == "Exclude-EWMA2-birth-HT-HC-ext" ~ "EWMA2 birth HT HC ext",
    x == "Exclude-EWMA2-birth-WT" ~ "EWMA2 birth WT",

    # --- Evil twins step ---
    x == "Exclude-Evil-Twins" ~ "Evil Twins",

    # --- Diff-based flags ---
    x == "Exclude-Min-diff" ~ "Min diff",
    x == "Exclude-Max-diff" ~ "Max diff",

    # --- SDEs (same-day extraneous) ---
    x == "Exclude-SDE-All-Exclude" ~ "SDE-All-Exclude",
    x == "Exclude-All-Extreme" ~ "All-Extreme",
    x == "Exclude-SDE-All-Extreme" ~ "SDE-All-Extreme",
    x == "Exclude-SDE-EWMA" ~ "SDE-EWMA",
    x == "Exclude-SDE-Identical" ~ "SDE-Identical",
    x == "Exclude-SDE-One-Day" ~ "SDE-One-Day",

    # --- Miscellaneous / other ---
    x == "Include" ~ "Include",
    x == "Exclude-Error-load" ~ "Error load",
    TRUE ~ x
  )
}
```

### Tester File Work

```{R}
### Run on SDE Tester File:
library(growthcleanr)
library(dplyr)
library(data.table)
library(dplyr)
library(data.table)
library(stringr)
library(gt)

# tester_in <- read.csv("../data/SDE-Tester-File.csv") %>% arrange(subjid, param, agedays) %>% mutate(obsid = row_number())

tester_stata <- read.csv("../data/temp_sde_tester.csv") %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  TRUE ~ "ERR"
))  
tester.work <- tester_stata %>% arrange(subjid, param, agedays, obsid)

# Load Modified code <- 
files <- list.files("../code/modified_source_code/", pattern = "\\.[rR]$", full.names = TRUE)
sapply(files, source, local = TRUE)
invisible(lapply(files, function(f) source(f, chdir = TRUE)))
source(knitr::purl("../code/modified_source_code/Contracted_Fix_Main.Rmd", output = tempfile()))

temp.work <- as.data.table(tester.work)
setkey(temp.work, subjid, param, agedays)
cleaned_data_updated <- cleangrowth(
  subjid = temp.work$subjid,
  param = temp.work$param,
  agedays = temp.work$agedays,
  sex = temp.work$sex,
  measurement = temp.work$measurement,
  prelim_infants = TRUE,
  id = temp.work$obsid, 
  sd.recenter = "nhanes",
  quietly = FALSE
)

df <- merge(tester_stata %>% select(obsid, gcr_result_carrie), cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))

tbl <- df %>%
  count(gcr_result_carrie, exclude) %>%
  arrange(desc(n))
print_table <- function(tbl) {
  gt(tbl) %>%
    fmt_number(columns = "n", sep_mark = ",") %>%
    
    # column 1 always green
    data_color(
      columns = c(gcr_result_carrie),
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    
    # column 2: green if matches col1, orange otherwise
    data_color(
      columns = c(exclude),
      rows = exclude == gcr_result_carrie,
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    data_color(
      columns = c(exclude),
      rows = exclude != gcr_result_carrie,
      fn = function(x) rep("#F2994A", length(x))
    )
}
print_table(tbl)

```

### 1Pct File Work

```{R}
### Run on SDE Tester File:
library(growthcleanr)
library(dplyr)
library(data.table)
library(dplyr)
library(data.table)
library(stringr)
library(gt)

# tester_in <- read.csv("../data/SDE-Tester-File.csv") %>% arrange(subjid, param, agedays) %>% mutate(obsid = row_number())

tester_stata <- read.csv("../data/2025-11-09-gc-Stata-chopd1p-results.csv") %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  param == "HEADCM" ~ exc_hc
)) 

tester.work <- tester_stata %>% arrange(subjid, param, agedays, obsid)

# Load Modified code
files <- list.files("../code/modified_source_code/", pattern = "\\.[rR]$", full.names = TRUE)
sapply(files, source, local = TRUE)
invisible(lapply(files, function(f) source(f, chdir = TRUE)))
source(knitr::purl("../code/modified_source_code/Contracted_Fix_Main.Rmd", output = tempfile()))

temp.work <- as.data.table(tester.work)
temp.work <- temp.work #%>% filter(subjid %in% checkpoint$subjid)
setkey(temp.work, subjid, param, agedays)
cleaned_data_updated <- cleangrowth(
  subjid = temp.work$subjid,
  param = temp.work$param,
  agedays = temp.work$agedays,
  sex = temp.work$sex,
  measurement = temp.work$measurement,
  prelim_infants = TRUE,
  id = temp.work$obsid, 
  sd.recenter = "nhanes",
  quietly = FALSE
)

df <- merge(tester_stata %>% select(obsid, gcr_result_carrie), cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))

tbl <- df %>% filter(!gcr_result_carrie == "ERR")%>%
  count(gcr_result_carrie, exclude) %>%
  arrange(desc(n))
print_table <- function(tbl) {
  gt(tbl) %>%
    fmt_number(columns = "n", sep_mark = ",") %>%
    
    # column 1 always green
    data_color(
      columns = c(gcr_result_carrie),
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    
    # column 2: green if matches col1, orange otherwise
    data_color(
      columns = c(exclude),
      rows = exclude == gcr_result_carrie,
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    data_color(
      columns = c(exclude),
      rows = exclude != gcr_result_carrie,
      fn = function(x) rep("#F2994A", length(x))
    )
}
print_table(tbl)
```

```{r}
Eval_dataset <- merge(temp.work, cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))
Eval_dataset <- Eval_dataset %>% group_by(subjid) %>% filter(any((gcr_result_carrie == "SDE-EWMA"  & exclude == "Include") | (gcr_result_carrie == "Include"  & exclude == "SDE-EWMA"))) %>% relocate(gcr_result_carrie, exclude, param)
# live_block <- read_csv("~/Github/Daymont_Contract/growthcleanr/cp/data/testoutsdeneww.csv")

# write.csv(live_block, paste("../data/SDE-EWMA-Include-Flips_Block_", Sys.Date(), ".csv", sep = ""))
live_block <- read_csv("~/Github/Daymont_Contract/growthcleanr/cp/data/SDE-EWMA-Include-Flips_Block_2025-11-14.csv")

live_block
 ### Issue Summary as of 11/14/2025:
# SDE Ewmas - In the 1% there are 121 rows which are Include-STATA and SDE-EWMA-R.
# SDE Ewmas - In the 1% there are 106 rows which are Include-STATA and SDE-EWMA-R.
# 106 are just pairs where we selected the opposite one.
# 15 are different. Let's examine them.
# After examining them - they appear to be correct in my code - verdict: STATA is picking the wrong ones. 
# I have also validated that include -> ewma2 first seem correct.
# Identify rows where Carrie and you disagree in the specific SDE-EWMA way
disagreements <- Eval_dataset %>%
  mutate(type =
           case_when(
             gcr_result_carrie == "SDE-EWMA" & exclude == "Include" ~ "carrie_SDEEWMA",
             gcr_result_carrie == "Include"  & exclude == "SDE-EWMA" ~ "R_SDEEWMA",
             TRUE ~ NA_character_
           )) %>%
  filter(!is.na(type))
# write.csv(disagreements, paste("../data/SDEMismatches", Sys.Date(), ".csv", sep = ""))
# Now evaluate whether each day-level cluster holds a complementary pair
paired_check <- disagreements %>%
  group_by(subjid, param, agedays) %>%
  mutate(
    n_carrie_only = sum(type == "carrie_SDEEWMA"),
    n_you_only    = sum(type == "R_SDEEWMA"),
    obsid,
    is_clean_pair = (n_carrie_only == 1 & n_you_only == 1)
  ) 

non_paired_ids <- paired_check$obsid[paired_check$is_clean_pair == FALSE]
non_paired_mismatch <- paired_check %>% group_by(subjid) %>% filter(any(is_clean_pair == FALSE))
non_paired_mismatches <- live_block %>% mutate(flag = case_when(id %in%non_paired_ids ~ TRUE,
                                                                TRUE ~ FALSE)) %>% group_by(subjid) %>% filter(any(flag == TRUE)) %>% relocate(flag)
# View(non_paired_mismatches)
table(paired_check$is_clean_pair)

View(non_paired_mismatches %>% filter(subjid == "31198") %>% group_by(agedays) %>% filter(any(flag == TRUE)))
table <- merge(live_block %>% filter(subjid %in% paired_check$subjid), paired_check %>% select(obsid, gcr_result_carrie), by.x = "id", by.y = "obsid") %>% relocate(gcr_result_carrie, exclude) %>% select(-c(...1, ...2))
# non_paired_mismatches$
write.csv(table, paste("../data/Examples_of_SDE-EWMA_Mismatches", Sys.Date(), ".csv", sep = ""))

View(cleaned_data_updated)
```


```{r}
View(cleaned_data_updated %>% group_by(subjid) %>% filter(any(grepl("Temp", exclude))))
```


```{R}
Eval_dataset <- merge(temp.work, cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))
Eval_dataset_n <- Eval_dataset %>% group_by(subjid) %>% filter(any((gcr_result_carrie == "Include"  & exclude == "EWMA2 first"))) %>% relocate(gcr_result_carrie, exclude, param)

Eval_dataset_n2 <- Eval_dataset %>% group_by(subjid) %>% filter(any((gcr_result_carrie == "Include"  & exclude == "Exclude-SDE-EWMA-All-Extreme"))) %>% relocate(gcr_result_carrie, exclude, param)


View(Eval_dataset_n2)
```

```{r}
# Here is a case where our R code did not flag the right one. Let's subset our 1% data to filter for the folks in this SDE problem dataset and re-run:
tester_stata <- read.csv("../data/2025-11-09-gc-Stata-chopd1p-results.csv") %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  param == "HEADCM" ~ exc_hc
)) 

tester.work <- tester_stata %>% arrange(subjid, param, agedays, obsid)

temp.work <- as.data.table(tester.work)
temp.work <- temp.work %>% filter(subjid %in% disagreements$subjid)
setkey(temp.work, subjid, param, agedays)
cleaned_data_updated <- cleangrowth(
  subjid = temp.work$subjid,
  param = temp.work$param,
  agedays = temp.work$agedays,
  sex = temp.work$sex,
  measurement = temp.work$measurement,
  prelim_infants = TRUE,
  id = temp.work$obsid, 
  sd.recenter = "nhanes",
  quietly = FALSE
)

df <- merge(tester_stata %>% select(obsid, gcr_result_carrie), cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))

tbl <- df %>% filter(!gcr_result_carrie == "ERR")%>%
  count(gcr_result_carrie, exclude) %>%
  arrange(desc(n))
print_table <- function(tbl) {
  gt(tbl) %>%
    fmt_number(columns = "n", sep_mark = ",") %>%
    
    # column 1 always green
    data_color(
      columns = c(gcr_result_carrie),
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    
    # column 2: green if matches col1, orange otherwise
    data_color(
      columns = c(exclude),
      rows = exclude == gcr_result_carrie,
      fn = function(x) rep("#6FCF97", length(x))
    ) %>%
    data_color(
      columns = c(exclude),
      rows = exclude != gcr_result_carrie,
      fn = function(x) rep("#F2994A", length(x))
    )
}
print_table(tbl)

```

```{r}

df_out <- merge(tester_stata , cleaned_data_updated %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))

df_out <- df_out %>% group_by(subjid) %>% filter(any((gcr_result_carrie == "SDE-EWMA"  & exclude == "Include") | (gcr_result_carrie == "Include"  & exclude == "SDE-EWMA"))) %>% relocate(gcr_result_carrie, exclude, param)

checkpoint <- read.csv("../data/testoutsdeneww.csv") %>% filter(subjid %in% df_out$subjid)

checkpoint <- checkpoint %>% group_by(subjid, agedays)%>% filter(any(exclude == "Exclude-SDE-EWMA"))

checkpoint
```

### Live Debug Block:


```{R}
live_block <- read.csv("../data/Data.df_for_new.sde_method2025-11-11.csv") 
live_block <- live_block %>% mutate(exclude = "Include")
# sde_onedays <- read.csv("../data/sde-oneday-folks-11-12-2025.csv")
# live_block <- live_block %>% filter(subjid %in% sde_onedays$subjid.x)
data.df <- live_block %>% as.data.table()
setkey(data.df, subjid, param, agedays)

  ### SDE 
  
data.df[exclude == 'Exclude-Temporary-Extraneous-Same-Day', exclude := 'Include']
data.df[temporary_extraneous_infants(data.df), exclude := 'Exclude-Temporary-Extraneous-Same-Day']
# View(data.df)
keep_cols_sde <- names(data.df)
data.df <- data.df %>%
  as.data.frame()  %>%
  # subset(valid(data.df, include.temporary.extraneous = TRUE) & nnte_full == FALSE) %>% mutate(id = id) %>%
  # select(subjid, id = id, agedays, param, v, tbc.sd, exclude, nnte_full) %>%
  group_by(subjid, param, agedays) %>%
  mutate(sde_this = case_when(
             any(exclude == "Exclude-Temporary-Extraneous-Same-Day") ~ TRUE,
             TRUE ~ FALSE
           )) 
data.sde <- data.df %>%
  group_by(subjid) %>%
  filter(valid(cur_data(), include.temporary.extraneous = TRUE) & !nnte_full) %>%
  mutate(id = id) %>%
  filter(any(sde_this == TRUE)) %>%
  arrange(subjid, param, agedays, id) %>%
  group_by(subjid, param, agedays) %>%
  mutate(
    exclude = case_when(
      length(unique(v)) == 1 &
        id != max(id, na.rm = TRUE) ~ "Exclude-SDE-Identical",
      TRUE ~ exclude
    )
  ) %>%
  group_by(subjid, param, agedays, v) %>%
  mutate(
    dup_count = n(),
    exclude = case_when(
      dup_count > 1 &
        id != max(id, na.rm = TRUE) &
        exclude != "Include" ~ "Exclude-SDE-Identical",
      TRUE ~ exclude
    )
  ) 
data.sde <- data.sde %>% data.table()
setkey(data.sde, subjid, param, agedays)


data.sde[exclude == 'Exclude-Temporary-Extraneous-Same-Day', exclude := 'Include']
data.sde[temporary_extraneous_infants(data.sde), exclude := 'Exclude-Temporary-Extraneous-Same-Day']
data.sde <- data.sde %>% as.data.frame() %>% arrange(subjid, param, agedays, id)
data.sde <- data.sde %>%
  # -------------------------------------------
  # Identify subjectâ€“parameter pairs eligible for "One-Day SDE" logic
  # -------------------------------------------
  group_by(subjid, param) %>%
  mutate(
    n_days_with_data = n_distinct(agedays[exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day")]),
    has_sde_day = any(exclude == "Exclude-Temporary-Extraneous-Same-Day"),
    one_day_sde_flag = (n_days_with_data == 1 & has_sde_day)
  ) %>%
  
  # -------------------------------------------
  # Only run the following steps for one-day SDE subjects/params
  # -------------------------------------------
group_by(subjid, param, agedays) %>%
  mutate(
    
    median_tbc = median(tbc.sd[exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day")], na.rm = TRUE),
    
    absdiff_rel_to_median = case_when(
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") ~ abs(tbc.sd - median_tbc),
      TRUE ~ NA
    ),
    
    min_absdiff_rel_to_median = min(absdiff_rel_to_median, na.rm = TRUE),
    
    median_tbc_gt2 = ifelse(
      one_day_sde_flag &
        min(absdiff_rel_to_median, na.rm = TRUE) > 2,
      TRUE,
      FALSE
    )
  ) %>% 
  ungroup() %>% 
  mutate(
    exclude = ifelse(
    !is.na(
      absdiff_rel_to_median) & one_day_sde_flag & min_absdiff_rel_to_median > 2,
      "Exclude-SDE-All-Extreme",
      exclude
    ),
    exclude = case_when(
      one_day_sde_flag &
        sum(
          exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day"),
          na.rm = TRUE
        ) == 1 &
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") &
        absdiff_rel_to_median != suppressWarnings(min(absdiff_rel_to_median[exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day")], na.rm = TRUE)) ~ "Exclude-SDE-One-Day",
      TRUE ~ exclude
    )) %>%

  # -------------------------------------------
  # dop-median tie-breaking logic (applies only to one-day SDEs)
  # -------------------------------------------
  group_by(subjid, agedays) %>%
  mutate(
    HT_dop_med = ifelse(one_day_sde_flag & param == "HEIGHTCM",
                        median(tbc.sd[exclude %in% c("Include") & param == "WEIGHTKG"], na.rm = TRUE), NA),
    WT_dop_med = ifelse(one_day_sde_flag & param == "WEIGHTKG",
                        median(tbc.sd[exclude %in% c("Include") & param == "HEIGHTCM"], na.rm = TRUE), NA),
    absdiff_dop_med = case_when(
      one_day_sde_flag &
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") & param == "HEIGHTCM" ~ abs(tbc.sd - HT_dop_med),
      one_day_sde_flag &
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") & param == "WEIGHTKG" ~ abs(tbc.sd - WT_dop_med),
      TRUE ~ NA
    )
  ) %>%
  group_by(subjid, param, agedays) %>%
  mutate(
    tied_vals = sum(exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day"), na.rm = TRUE),
    min_absdiff_dop_median = suppressWarnings(min(absdiff_dop_med, na.rm = TRUE)),
    n_min_dop = sum(
      exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") &
        absdiff_dop_med == min_absdiff_dop_median,
      na.rm = TRUE
    ),
    exclude = case_when(
      one_day_sde_flag &
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") &
        tied_vals > 1 &
        !is.na(absdiff_dop_med) &
        absdiff_dop_med != min_absdiff_dop_median ~ "Exclude-SDE-One-Day",
      TRUE ~ exclude
    ),
    tied_vals = sum(exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day"), na.rm = TRUE),
    exclude = case_when(
      one_day_sde_flag &
        tied_vals > 1 &
        exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day") &
        id != max(id[exclude %in% c("Include", "Exclude-Temporary-Extraneous-Same-Day")], na.rm = TRUE) ~ "Exclude-SDE-One-Day",
      TRUE ~ exclude
    )
  ) %>%
  ungroup()

              # h. no need to calculate for R.

              # D. SDE-EWMAs

              # a. Calculate EWMA for full included vals
              ewma_df <- as.data.table(data.sde %>% filter(exclude == "Include"))
              setkey(ewma_df, subjid, param, agedays)
              
              # tmp <- data.frame(
              #           "before" = abs(ewma_df$agedays - c(NA, ewma_df$agedays[1:(nrow(ewma_df)-1)])),
              #           "after" = abs(ewma_df$agedays - c(ewma_df$agedays[2:(nrow(ewma_df))], NA))
              #         )
              # maxdiff <- pmax(tmp$before, tmp$after, na.rm = TRUE)
              # # maxdiff <- sapply(1:nrow(tmp), function(x){max(tmp[x,], na.rm = TRUE)})
              # # exp_vals <- rep(-1.5, nrow(tmp))
              # # exp_vals[maxdiff > 365.25] <- -2.5
              # # exp_vals[maxdiff > 730.5] <- -3.5
              # # approximate continuous exponential decay equivalent to Stata's add(5)
              # # convert each observation's mean time gap to a smooth exponent
              # For each subject and parameter, calculate before/after gaps and assign exponent
              ewma_df[, c("diff_before", "diff_after") :=
              .(c(NA, diff(agedays)), c(diff(agedays), NA)),
              by = .(subjid, param)]
              
              # Take the larger gap (the "Ba" value) and convert to years
              ewma_df[, maxdiff := pmax(abs(diff_before), abs(diff_after), na.rm = TRUE)]
              ewma_df[, ageyears := maxdiff / 365.25]
              
              # Apply the exact linear exponent rule from the specification
              ewma_df[, exp_val := fcase(
              ageyears <= 1, -1.5,
              ageyears >= 3, -3.5,
              default = -1.5 - (ageyears - 1)
              )]

# Compute EWMA using these exponents
ewma.fields <- c("ewma.all", "ewma.before", "ewma.after")
ewma_df[, (ewma.fields) := ewma(agedays, tbc.sd, exp_val, TRUE), by = .(subjid, param)]
              # avg_gap <- rowMeans(tmp, na.rm = TRUE)
              # exp_vals <- -1.5 * exp(-avg_gap / 365.25)
              # ewma.fields <- c('ewma.all', 'ewma.before', 'ewma.after')
              # ewma_df[, (ewma.fields) := ewma(agedays, tbc.sd, exp_vals, TRUE)] %>% as.data.frame()
              data.sde <- merge(data.sde, ewma_df %>%
                                 select(id, which(grepl("ewma", names(ewma_df)))), by = "id", all.x = TRUE)
              data.sde <- data.sde %>%
                group_by(subjid, param, agedays) %>%
                # b. Assign EWMAs to partially included vals.
                mutate(ewma.all = case_when(is.na(ewma.all) & exclude == "Exclude-Temporary-Extraneous-Same-Day" ~ max(ewma.all[exclude == "Include"], na.rm = TRUE),
                                            TRUE ~ ewma.all),
                                                                                 absdewma = abs(tbc.sd - ewma.all)) %>%
                # c. If there's one fully or partially included value (n_min_absdewma == 1) with the lowest absdewma (absdewma == min_absdewma)
                mutate(
                  n_available = sum(exclude %in% c("Exclude-Temporary-Extraneous-Same-Day",
                                                  "Include"), na.rm = TRUE),
                  min_absdewma = suppressWarnings(min(absdewma[exclude %in% c("Exclude-Temporary-Extraneous-Same-Day",
                                                  "Include")],
                                                      na.rm = TRUE)),
                  min_absdewma = ifelse(is.infinite(min_absdewma), NA_real_, min_absdewma),

                  n_min_absdewma = sum(exclude %in% c("Exclude-Temporary-Extraneous-Same-Day",
                                                  "Include") &
                                         absdewma == min_absdewma, na.rm = TRUE),
                  exclude_flag = NA,
                   # Rule set 1: single min_absdewma
    exclude = case_when(n_available > 0 & min_absdewma >2 ~ "Exclude-SDE-EWMA-All-Extreme", TRUE ~ exclude),
    exclude = case_when(
      n_available > 0 &
        n_min_absdewma == 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") &
        absdewma == min_absdewma ~ "Include",
      n_available > 0 &
        n_min_absdewma == 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") &
        absdewma != min_absdewma ~ "Exclude-SDE-EWMA",
      TRUE ~ exclude
    ),
    exclude_flag = case_when(
      n_available > 0 &
        n_min_absdewma == 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") ~ 1L,
      TRUE ~ exclude_flag
    )
  ) %>%
  mutate(
    # Rule set 2: multiple tied min_absdewma values
    exclude = case_when(
      n_available > 0 &
        n_min_absdewma > 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") &
        absdewma == min_absdewma &
        id == max(id[absdewma == min_absdewma &
                       exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include")],
                  na.rm = TRUE) ~ "Include",
      n_available > 0 &
        n_min_absdewma > 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") &
        absdewma == min_absdewma &
        id != max(id[absdewma == min_absdewma &
                       exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include")],
                  na.rm = TRUE) ~ "Exclude-SDE-EWMA",
      TRUE ~ exclude
    ),
    exclude_flag = case_when(
      n_available > 0 &
        n_min_absdewma > 1 &
        exclude %in% c("Exclude-Temporary-Extraneous-Same-Day", "Include") ~ 2L,
      TRUE ~ exclude_flag
    )
  ) %>%
  ungroup()
            
# 
# print(data.sde)      
data.df <- merge(data.df, data.sde %>% select(id, sde_exclude = exclude),by = "id", all.x = TRUE) %>% mutate(exclude = case_when(!is.na(sde_exclude) ~ sde_exclude,
                                                                                                          TRUE ~ exclude))
# print("AAA")
# data.df <- data.df %>% select(which(names(data.df) %in% keep_cols_sde))
    # data.df <- as.data.table(data.df)
    # setkey(data.df, subjid, param, agedays)
# write.csv(data.df, "../data/testoutsdeneww.csv")
     # data.df              
df <- merge(tester_stata %>% select(obsid, gcr_result_carrie), data.df %>% select(obsid = id, exclude), by = "obsid") %>% mutate(gcr_result_carrie = map_to_stata(gcr_result_carrie), exclude = map_to_stata(exclude), res = paste(gcr_result_carrie, exclude))
# 
# View(data.df)


tbl <- df %>%
  count(gcr_result_carrie, exclude) %>%
  arrange(desc(n))

print_table(tbl)

# write.csv(data.sde, paste("../data/sde_tester_output_R", Sys.Date(), ".csv", sep = ""))
```

```{R}
View(data.sde %>% filter(subjid == 12121212))
View(tester_stata %>% select(id = obsid, subjid, agedays, gcr_result_carrie))
### The below shows the evil twins issue - leave off the forced "include" at the top of the live test block, run the live test block then run this. I think even in the original stata tester the tbc_wtz would throw 
View(tester_stata %>% select(obsid, subjid, agedays, param, tbcwtz) %>% arrange(subjid, param, agedays, obsid))
```

```{R}

```
