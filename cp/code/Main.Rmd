---
title: "R Notebook"
output: html_notebook
---

```{r}
library(growthcleanr)
library(dplyr)
library(data.table)
library(dplyr)
library(data.table)
library(stringr)
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(include = FALSE, echo = FALSE, eval = TRUE)
```

**Pausing Code to Evaluate Changes Thus Far**

1. Generate Baseline - STATA vs. Unmodified R Code
```{R, eval = FALSE}
# Let's evaluate the baseline GC (i.e., unmodified source files) against the modified code, strictly in terms of gcr_result only.
files <- list.files("../../R/", pattern = "\\.[rR]$", full.names = TRUE)
sapply(files, source, local = TRUE)
invisible(lapply(files, function(f) source(f, chdir = TRUE)))
# Load in STATA output:
stata_gc_in <- data.table::fread("../data/2025-10-01-gc-Stata-chopd1p-results.csv")

data.work <- stata_gc_in %>% select(
  id,
  subjid,
  param,
  sex,
  agedays,
  param,
  measurement,
  exc_wt,
  exc_ht,
  potcorr,
  tbcwtz,
  ctbcwtz
) %>% mutate(param = case_when(
  param == "Weight" ~ "WEIGHTKG",
  param == "Height" ~ "HEIGHTCM",
  TRUE ~ param
)) %>% filter(param %in% c("WEIGHTKG", "HEIGHTCM"))

data.work <- data.work %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  TRUE ~ "ERR"
)) %>% select(-c(exc_wt, exc_ht)) 
data.work <- data.work  %>% filter(subjid %in% Merged_Maps_sub$subjid.x)

data.work <- as.data.table(data.work)
setkey(data.work, subjid, param, agedays)
cleaned_data <- data.work[,gcr_result_cp := cleangrowth(subjid, param, agedays, sex, measurement, prelim_infants = TRUE,  sd.recenter = "nhanes")]
# View(cleaned_data %>% filter(subjid == "444336"))
# Baseline_Characteristics_Table
Baseline_Characteristics_Table <- cleaned_data %>% select(gcr_result_carrie, gcr_result_cp) %>% mutate(gcr_result_cp = gsub("^Exclude", "", gcr_result_cp),
                                gcr_result_cp = gsub("-", " ", gcr_result_cp),
                                gcr_result_cp = str_trim(gcr_result_cp),
                                gcr_result_carrie = tolower(gcr_result_carrie),
                                gcr_result_cp = tolower(gcr_result_cp),
                                results_pasted = paste(gcr_result_carrie, gcr_result_cp, sep = " ; "))

Baseline_Characteristics_Table <- as.data.frame(table(Baseline_Characteristics_Table$results_pasted)) %>% arrange(desc(Freq))
# write.csv(Baseline_Characteristics_Table, paste("../deliverables/Baseline_Characteristics_Table", Sys.Date(), ".csv", sep = ""))
```

2. Generate Current - STATA vs. Modified R Code

```{r}
# Load Modified code
files <- list.files("../code/modified_source_code/", pattern = "\\.[rR]$", full.names = TRUE)
sapply(files, source, local = TRUE)
invisible(lapply(files, function(f) source(f, chdir = TRUE)))
source(knitr::purl("../code/modified_source_code/Contracted_Fix_Main.Rmd", output = tempfile()))
# Load in STATA output:
stata_gc_in <- data.table::fread("../data/2025-10-01-gc-Stata-chopd1p-results.csv")

data.work <- stata_gc_in %>% select(
  id,
  subjid,
  param,
  sex,
  agedays,
  param,
  measurement,
  exc_wt,
  exc_ht,
  potcorr,
  tbcwtz,
  ctbcwtz
) %>% mutate(param = case_when(
  param == "Weight" ~ "WEIGHTKG",
  param == "Height" ~ "HEIGHTCM",
  TRUE ~ param
)) %>% filter(param %in% c("WEIGHTKG", "HEIGHTCM"))

data.work <- data.work %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  TRUE ~ "ERR"
)) %>% select(-c(exc_wt, exc_ht)) 
data.work <- as.data.table(data.work)
setkey(data.work, subjid, param, agedays)
cleaned_data_updated <- cleangrowth(
  subjid = data.work$subjid,
  param = data.work$param,
  agedays = data.work$agedays,
  sex = data.work$sex,
  measurement = data.work$measurement,
  prelim_infants = TRUE,
  id = data.work$id, sd.recenter = "nhanes"
)

# write.csv(cleaned_data_updated, paste("../data/Checkpoint_Updated_R_", Sys.Date(), ".csv", sep = ""))

Modified_Characteristics_Table <- merge(data.work %>% select(id, gcr_result_carrie), cleaned_data_updated %>% select(id, exclude), by = "id")

# Modified_Characteristics_Table
Modified_Characteristics_Table <- Modified_Characteristics_Table %>% select(gcr_result_carrie, gcr_result_cp_updated = exclude) %>% mutate(gcr_result_cp_updated = gsub("^Exclude", "", gcr_result_cp_updated),
                                gcr_result_cp_updated = gsub("-", " ", gcr_result_cp_updated),
                                gcr_result_cp_updated = str_trim(gcr_result_cp_updated),
                                gcr_result_carrie = tolower(gcr_result_carrie),
                                gcr_result_cp_updated = tolower(gcr_result_cp_updated),
                                results_pasted = paste(gcr_result_carrie, gcr_result_cp_updated, sep = " ; "))

Modified_Characteristics_Table <- as.data.frame(table(Modified_Characteristics_Table$results_pasted)) %>% arrange(desc(Freq))
# write.csv(Modified_Characteristics_Table, paste("../deliverables/Modified_Characteristics_Table", Sys.Date(), ".csv", sep = ""))
```

```{r}
Baseline_Map <- read.csv("../data/baseline_comparison_of_stata_vs_R_2025-10-07.csv") %>% select(id, gcr_result_carrie, gcr_result_cp)
# Updated_Map <- read.csv("../data/Checkpoint_Updated_R_2025-10-14.csv") %>% select(id, gcr_result_cp_updated = exclude)
Updated_Map <- cleaned_data_updated %>% select(id, gcr_result_cp_updated = exclude)
Merged_Maps <- merge(Baseline_Map, Updated_Map, by = "id")


map_to_stata <- function(x) {
  case_when(
    # --- Carry-forward family ---
    x == "Exclude-1-CF-deltaZ-<0.05" ~ "1 CF deltaZ <0.05",
    x == "Exclude-1-CF-deltaZ-<0.1-wholehalfimp" ~ "1 CF imperial deltaZ <0.1",
    x == "Exclude-Teen-2-plus-CF-deltaZ-<0.05" ~ "Carried forward",
    x == "Exclude-Carried-Forward" ~ "Carried forward",

    # --- Measurement count flags ---
    x == "Exclude-1-meas" ~ "1 meas",
    x == "Exclude-2-meas-<1-year" ~ "2 meas <1 year",
    x == "Exclude-2-meas->1-year" ~ "2 meas >1 year",

    # --- Biologically implausible values ---
    x == "Exclude-Absolute-BIV" ~ "Absolute BIV",
    x == "Exclude-Standardized-BIV" ~ "Standardized BIV",

    # --- EWMA steps ---
    x == "Exclude-EWMA1-Extreme" ~ "EWMA1 high sum",
    x == "Exclude-EWMA2-middle" ~ "EWMA2 middle",
    x == "Exclude-EWMA2-first" ~ "EWMA2 first",
    x == "Exclude-EWMA2-first-ext" ~ "EWMA2 first ext",
    x == "Exclude-EWMA2-last" ~ "EWMA2 last",
    x == "Exclude-EWMA2-birth-HT-HC" ~ "EWMA2 birth HT HC",
    x == "Exclude-EWMA2-birth-HT-HC-ext" ~ "EWMA2 birth HT HC ext",
    x == "Exclude-EWMA2-birth-WT" ~ "EWMA2 birth WT",

    # --- Evil twins step ---
    x == "Exclude-Evil-Twins" ~ "Evil Twins",

    # --- Diff-based flags ---
    x == "Exclude-Min-diff" ~ "Min diff",
    x == "Exclude-Max-diff" ~ "Max diff",

    # --- SDEs (same-day extraneous) ---
    x == "Exclude-SDE-All-Exclude" ~ "SDE-All-Exclude",
    x == "Exclude-SDE-All-Extreme" ~ "SDE-Extreme",
    x == "Exclude-SDE-EWMA" ~ "SDE-EWMA",
    x == "Exclude-SDE-Identical" ~ "SDE-Identical",
    x == "Exclude-SDE-One-Day" ~ "SDE-One-Day",

    # --- Miscellaneous / other ---
    x == "Include" ~ "Include",
    x == "Exclude-Error-load" ~ "Error load",

    TRUE ~ "Unmapped"
  )
}

# Apply mapping to both columns
Merged_Maps <- Merged_Maps %>%
  mutate(
    gcr_result_cp = map_to_stata(gcr_result_cp),
    gcr_result_cp_updated = map_to_stata(gcr_result_cp_updated)
  )

library(networkD3)
library(dplyr)

Merged_Maps <- Merged_Maps %>% filter(gcr_result_carrie!=gcr_result_cp)

library(gt)
Merged_Maps %>%
  count(gcr_result_carrie, gcr_result_cp, gcr_result_cp_updated) %>%
  arrange(desc(n)) %>%
  gt::gt() %>%
  gt::fmt_number(columns = "n", sep_mark = ",")



```

```{R}
# According to this, there are still problems with over-flagging SDE one days on rows which are included in the stata.

Baseline_Map <- read.csv("../data/baseline_comparison_of_stata_vs_R_2025-10-07.csv") %>% select(id, gcr_result_carrie, gcr_result_cp)
Updated_Map <- read.csv("../data/Checkpoint_Updated_R_2025-10-14.csv")
datsel <- merge(Baseline_Map, Updated_Map, by = "id", all = TRUE) %>% group_by(subjid) %>% filter(any(gcr_result_carrie == "1 CF imperial deltaZ <0.1" & exclude == "Exclude-Carried-Forward"))
View(datsel)

SOIs<- unique(datsel$subjid)
```

```{R, include = TRUE}
# Load Modified code
files <- list.files("../code/modified_source_code/", pattern = "\\.[rR]$", full.names = TRUE)
sapply(files, source, local = TRUE)
invisible(lapply(files, function(f) source(f, chdir = TRUE)))
source(knitr::purl("../code/modified_source_code/Contracted_Fix_Main.Rmd", output = tempfile()))
# Load in STATA output:
stata_gc_in <- data.table::fread("../data/2025-10-01-gc-Stata-chopd1p-results.csv")
conflicted_pats <- read.csv("../data/ 2025-10-13 Primary_Discrepant_Pat_Hxs.csv")
conflicted_pats <- conflicted_pats$subjid
data.work <- stata_gc_in %>% 
  select(
  id,
  subjid,
  param,
  sex,
  agedays,
  param,
  measurement,
  exc_wt,
  exc_ht,
  potcorr,
  tbcwtz,
  ctbcwtz
) %>%
  mutate(param = case_when(
  param == "Weight" ~ "WEIGHTKG",
  param == "Height" ~ "HEIGHTCM",
  TRUE ~ param
)) %>% filter(param %in% c("WEIGHTKG", "HEIGHTCM"))

data.work <- data.work %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  TRUE ~ "ERR"
)) %>% select(-c(exc_wt, exc_ht)) 

# data.work <- data.work  %>% filter(subjid %in% mindiffs$subjid.x)
data.work <- data.work  %>% filter(subjid %in% problematic_pats$subjid.x)
data.work <- as.data.table(data.work)
setkey(data.work, subjid, param, agedays)
cleaned_data_updated <- cleangrowth(
  subjid = data.work$subjid,
  param = data.work$param,
  agedays = data.work$agedays,
  sex = data.work$sex,
  measurement = data.work$measurement,
  prelim_infants = TRUE,
  id = data.work$id, 
  sd.recenter = "nhanes"
)

# write.csv(cleaned_data_updated, paste("../data/Checkpoint_Updated_R_", Sys.Date(), ".csv", sep = ""))

Modified_Characteristics_Table <- merge(data.work, cleaned_data_updated %>% select(id, exclude), by = "id")

# Modified_Characteristics_Table
Modified_Characteristics_Table <- Modified_Characteristics_Table %>% select(gcr_result_carrie, gcr_result_cp_updated = exclude) %>% mutate(gcr_result_cp_updated = gsub("^Exclude", "", gcr_result_cp_updated),
                                gcr_result_cp_updated = gsub("-", " ", gcr_result_cp_updated),
                                gcr_result_cp_updated = str_trim(gcr_result_cp_updated),
                                gcr_result_carrie = tolower(gcr_result_carrie),
                                gcr_result_cp_updated = tolower(gcr_result_cp_updated),
                                results_pasted = paste(gcr_result_carrie, gcr_result_cp_updated, sep = " ; "))

Modified_Characteristics_Table <- as.data.frame(table(Modified_Characteristics_Table$results_pasted)) %>% arrange(desc(Freq))
# write.csv(Modified_Characteristics_Table, paste("../deliverables/Modified_Characteristics_Table", Sys.Date(), ".csv", sep = ""))
Modified_Characteristics_Table



Baseline_Map <- read.csv("../data/baseline_comparison_of_stata_vs_R_2025-10-07.csv") %>% select(id, gcr_result_carrie, gcr_result_cp, subjid)
# Updated_Map <- read.csv("../data/Checkpoint_Updated_R_2025-10-14.csv") %>% select(id, gcr_result_cp_updated = exclude)

# cleaned_data_updated <- read.csv("../data/Checkpoint_Updated_R_2025-10-21.csv")

Updated_Map <- cleaned_data_updated %>% select(id, subjid, gcr_result_cp_updated = exclude)
Merged_Maps <- merge(Baseline_Map, Updated_Map, by = "id")


map_to_stata <- function(x) {
  case_when(
    # --- Carry-forward family ---
    x == "Exclude-1-CF-deltaZ-<0.05" ~ "1 CF deltaZ <0.05",
    x == "Exclude-1-CF-deltaZ-<0.1-wholehalfimp" ~ "1 CF imperial deltaZ <0.1",
    x == "Exclude-Teen-2-plus-CF-deltaZ-<0.05" ~ "Carried forward",
    x == "Exclude-Carried-Forward" ~ "Carried forward",

    # --- Measurement count flags ---
    x == "Exclude-1-meas" ~ "1 meas",
    x == "Exclude-2-meas-<1-year" ~ "2 meas <1 year",
    x == "Exclude-2-meas->1-year" ~ "2 meas >1 year",

    # --- Biologically implausible values ---
    x == "Exclude-Absolute-BIV" ~ "Absolute BIV",
    x == "Exclude-Standardized-BIV" ~ "Standardized BIV",

    # --- EWMA steps ---
    x == "Exclude-EWMA1-Extreme" ~ "EWMA1 high sum",
    x == "Exclude-EWMA2-middle" ~ "EWMA2 middle",
    x == "Exclude-EWMA2-first" ~ "EWMA2 first",
    x == "Exclude-EWMA2-first-ext" ~ "EWMA2 first ext",
    x == "Exclude-EWMA2-last" ~ "EWMA2 last",
    x == "Exclude-EWMA2-birth-HT-HC" ~ "EWMA2 birth HT HC",
    x == "Exclude-EWMA2-birth-HT-HC-ext" ~ "EWMA2 birth HT HC ext",
    x == "Exclude-EWMA2-birth-WT" ~ "EWMA2 birth WT",

    # --- Evil twins step ---
    x == "Exclude-Evil-Twins" ~ "Evil Twins",

    # --- Diff-based flags ---
    x == "Exclude-Min-diff" ~ "Min diff",
    x == "Exclude-Max-diff" ~ "Max diff",

    # --- SDEs (same-day extraneous) ---
    x == "Exclude-SDE-All-Exclude" ~ "SDE-All-Exclude",
    x == "Exclude-SDE-All-Extreme" ~ "SDE-Extreme",
    x == "Exclude-SDE-EWMA" ~ "SDE-EWMA",
    x == "Exclude-SDE-Identical" ~ "SDE-Identical",
    x == "Exclude-SDE-One-Day" ~ "SDE-One-Day",

    # --- Miscellaneous / other ---
    x == "Include" ~ "Include",
    x == "Exclude-Error-load" ~ "Error load",

    TRUE ~ x
  )
}

# Apply mapping to both columns
Merged_Maps <- Merged_Maps %>%
  mutate(
    gcr_result_cp = map_to_stata(gcr_result_cp),
    gcr_result_cp_updated = map_to_stata(gcr_result_cp_updated)
  )


# summarise the data
tbl <- Merged_Maps %>%
  count(gcr_result_carrie, gcr_result_cp, gcr_result_cp_updated) %>%
  arrange(desc(n))

# build gt table with conditional coloring
gt(tbl) %>%
  fmt_number(columns = "n", sep_mark = ",") %>%
  
  # column 1 always green
  data_color(
    columns = c(gcr_result_carrie),
    fn = function(x) rep("#6FCF97", length(x))
  ) %>%
  
  # column 2: green if matches col1, orange otherwise
  data_color(
    columns = c(gcr_result_cp),
    rows = gcr_result_cp == gcr_result_carrie,
    fn = function(x) rep("#6FCF97", length(x))
  ) %>%
  data_color(
    columns = c(gcr_result_cp),
    rows = gcr_result_cp != gcr_result_carrie,
    fn = function(x) rep("#F2994A", length(x))
  ) %>%
  
  # column 3: same logic
  data_color(
    columns = c(gcr_result_cp_updated),
    rows = gcr_result_cp_updated == gcr_result_carrie,
    fn = function(x) rep("#6FCF97", length(x))
  ) %>%
  data_color(
    columns = c(gcr_result_cp_updated),
    rows = gcr_result_cp_updated != gcr_result_carrie,
    fn = function(x) rep("#F2994A", length(x))
  ) %>%
  data_color(
    columns = c(gcr_result_cp_updated),
    rows = gcr_result_cp == gcr_result_carrie & gcr_result_cp_updated != gcr_result_cp,
    fn = function(x) rep("maroon", length(x))
  )

# problematic_pats <- Merged_Maps %>% group_by(subjid.x) %>% filter(any(gcr_result_carrie != gcr_result_cp_updated))
# write.csv(problematic_pats, paste("../data/problematic_pats_", Sys.Date(), ".csv", sep = ""))
```

```{R}
### Gonna isolate a few groups here to test:
### Include-Min diff-Min diff
maxdiffs <- Merged_Maps %>% group_by(subjid.x) %>% filter(any(gcr_result_carrie == "Include" &gcr_result_cp == "Max diff" & gcr_result_cp_updated == "Max diff")) 
maxdiffs_folks <- maxdiffs %>% select(subjid.x) %>% distinct()


View(cleaned_data_updated %>% filter(subjid == "98863"))
sView(cleaned_data_updated %>% filter(exclude == "Exclude-Max-diff"))
```
result <- cleaned_data_updated %>%
  group_by(subjid, param) %>%
  arrange(agedays, .by_group = TRUE) %>%
  mutate(
    row_id = row_number(),
    flag_exclude = exclude == "Exclude-Max-diff"
  ) %>%
  mutate(
    # Mark neighbors of excluded rows
    neighbor = lag(flag_exclude, default = FALSE) | 
               flag_exclude | 
               lead(flag_exclude, default = FALSE)
  ) %>%
  filter(neighbor) %>%
  ungroup()


maxdiffs <- Merged_Maps %>% group_by(subjid.x) %>% filter(any(gcr_result_carrie == "Include" &gcr_result_cp == "Absolute BIV" & gcr_result_cp_updated == "Absolute BIV")) 
maxdiffs_folks <- maxdiffs %>% select(subjid.x) %>% distinct()
result <- cleaned_data_updated %>%
  group_by(subjid, param) %>%
  arrange(agedays, .by_group = TRUE) %>%
  mutate(
    row_id = row_number(),
    flag_exclude = exclude == "Absolute BIV"
  ) %>%
  mutate(
    # Mark neighbors of excluded rows
    neighbor = lag(flag_exclude, default = FALSE) | 
               flag_exclude | 
               lead(flag_exclude, default = FALSE)
  ) %>%
  filter(neighbor) %>%
  ungroup()

result

View(cleaned_data_updated %>% filter(subjid == "35211"))
View(cleaned_data_updated %>% filter(exclude == "Exclude-Max-diff"))
```


```{r}
View_selected_cases <- merge(data.work, cleaned_data_updated %>% select(id, exclude), by = "id")

# Modified_Characteristics_Table
View_selected_cases <- View_selected_cases %>% mutate(gcr_result_cp_updated = gsub("^Exclude", "", gcr_result_cp_updated),
                                gcr_result_cp_updated = gsub("-", " ", gcr_result_cp_updated),
                                gcr_result_cp_updated = str_trim(gcr_result_cp_updated),
                                gcr_result_carrie = tolower(gcr_result_carrie),
                                gcr_result_cp_updated = tolower(gcr_result_cp_updated),
                                results_pasted = paste(gcr_result_carrie, gcr_result_cp_updated, sep = " ; "))
View_selected_cases %>% relocate(exclude)
View(View_selected_cases$exclude)
```


```{r}
# Merged_Maps
EWMA_middle_folks <- Merged_Maps %>% group_by(subjid.x) %>% filter(any(gcr_result_carrie == "EWMA2 middle" & gcr_result_cp_updated == "Include")) 
# Select off cleaned data which represents this:
ewma2_diagnostics_all <- read_csv("~/Github/Daymont_Contract/growthcleanr/cp/data/ewma2_diagnostics_all.csv") %>% filter(subjid %in% EWMA_middle_folks$subjid.x)
ewma2_diagnostics_all <- merge(ewma2_diagnostics_all, EWMA_middle_folks %>% select(subjid = subjid.x, id, gcr_result_carrie, gcr_result_cp_updated) %>% distinct(), by = "id", all.x = TRUE)
View(ewma2_diagnostics_all %>% filter(subjid.x == unique(ewma2_diagnostics_all$subjid.x)[2]) %>% distinct())
ewma2_diagnostics_all %>% mutate(addcrithigh_cp :=
                    dewma.before > 1 & dewma.after > 1 &
                    ((tbc_diff_next > 1 & tbc_diff_plus_next > 1 & tbc_diff_minus_next > 1) | is.na(tbc_diff_next)) &
                    ((tbc_diff_prior > 1 & tbc_diff_plus_prior > 1 & tbc_diff_minus_prior > 1) | is.na(tbc_diff_prior))) %>% filter(subjid.x == "16210")


View(ewma2_diagnostics_all)
View(stata_gc_in)
```


```{r}
# Merged_Maps
carried_forward_folks <- Merged_Maps %>% group_by(subjid.x) %>% filter(any(gcr_result_carrie == "Carried forward" & gcr_result_cp_updated == "Include")) 
output <- read.csv("../data/Checkpoint_Updated_R_2025-10-14_evening.csv")
View(output)
```













```{r}

datsel <- merge(Baseline_Map, Updated_Map, by = c("id", "subjid"), all = TRUE) %>% group_by(subjid) %>% filter(any(gcr_result_carrie == "EWMA2 middle" & gcr_result_cp_updated == "Include")) #%>% distinct(subjid)
# Modified_Characteristics_Table <- merge(data.work, cleaned_data_updated %>% select(-subjid), by = "id")

View(Modified_Characteristics_Table  %>% select(subjid, agedays.x, param.x, sd.orig_uncorr, swtz, measurement, v, gcr_result_carrie, exclude))
Modified_Characteristics_Table$sd.orig_uncorr
View(datsel)
```


```{r}
data.work <- stata_gc_in  %>% mutate(param = case_when(
  param == "Weight" ~ "WEIGHTKG",
  param == "Height" ~ "HEIGHTCM",
  TRUE ~ param
)) %>% filter(param %in% c("WEIGHTKG", "HEIGHTCM"))

data.work <- data.work %>% mutate(gcr_result_carrie = case_when(
  param == "WEIGHTKG" ~ exc_wt,
  param == "HEIGHTCM" ~ exc_ht,
  TRUE ~ "ERR"
)) %>% select(-c(exc_wt, exc_ht)) 


ewma_dx <- read.csv("../data/ewma2_diagnostics_all.csv")
review_ewmas <- merge(data.work, ewma_dx, by = "id", all = TRUE)
View(review_ewmas %>% filter(subjid.x == "199479"))

View(review_ewmas)
```

**Now, we should compare the EWMA values for our data against the STATA outputs.**

```{R}
example_mindif_issue <- read.csv("../data/mindiff_debug_NNNNN.csv")
df <- example_mindif_issue %>%
  dplyr::select(id,
    subjid, param, agedays, v, exclude,
    tbc.sd, ctbc.sd,
    ewma.all, ewma.before, ewma.after,
    dewma.all, dewma.before, dewma.after,
    exp_vals,
    diff_prev, diff_next,
    mindiff_prev, mindiff, maxdiff_prev, maxdiff,
    pair, bef.g.aftm1, aft.g.aftm1
    # val_excl
  )
df


View()

# Check pair logic:

if (nrow(df) > 2){
        # 17P/R: identify pairs and calculate exclusions
        df[, pair := (v-dplyr::lag(v)) < mindiff_prev |
             (dplyr::lead(v)-v) < mindiff |
             (v-dplyr::lag(v)) > maxdiff_prev | (dplyr::lead(v)-v) > maxdiff
        ]
  
  df <- df %>% mutate(pair_Cp_condition1 = (v-dplyr::lag(v)) <= mindiff_prev)
  df <- df %>% mutate(pair_Cp_condition2 = round(dplyr::lead(v)-v,1) <= mindiff ,
                      pair_Cp_condition3 = (v-dplyr::lag(v)) >= maxdiff_prev,
                      pair_Cp_condition4 = (dplyr::lead(v)-v) >= maxdiff,
                      pair_Cp_condition2_value_1 = round(dplyr::lead(v)-v,1),
                      pair_Cp_condition2_cp = round(dplyr::lead(v)-v,1) <= mindiff,
                      mindiff_put = mindiff)
df  


View(Modified_Characteristics_Table)


```


```{r}
temp_stata_ewma_middle <- stata_gc_in %>% select(subjid, agedays, id, tbchtz, measurement, param,) %>% filter(param == "HEIGHTCM" & subjid == "16210") %>% arrange(agedays)

tempdf <- calc_and_recenter_z_scores(temp_stata_ewma_middle, "p_plus", ref.data.path)

```



