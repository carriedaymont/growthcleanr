<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with large data sets • growthcleanr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with large data sets">
<meta property="og:description" content="growthcleanr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">growthcleanr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Getting started</li>
    <li>
      <a href="../articles/quickstart.html">Quickstart</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/usage.html">Usage</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced topics</li>
    <li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/output.html">Understanding growthcleanr output</a>
    </li>
    <li>
      <a href="../articles/adult-algorithm.html">Adult algorithm</a>
    </li>
    <li>
      <a href="../articles/utilities.html">Utilities for computing pediatric BMI percentiles, Z-scores, and related tools</a>
    </li>
    <li>
      <a href="../articles/large-data-sets.html">Working with large data sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mitre/growthcleanr">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="large-data-sets_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with large data sets</h1>
            
            <h4 class="date">2021-06-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mitre/growthcleanr/blob/main/vignettes/large-data-sets.Rmd"><code>vignettes/large-data-sets.Rmd</code></a></small>
      <div class="hidden name"><code>large-data-sets.Rmd</code></div>

    </div>

    
    
<p>The nature of the <code>growthcleanr</code> algorithm is repetitive. It runs many checks over each individual subject’s measurements, in a specific sequence, and revises its assessments as it goes. Because of this, it can take some time to process even a modest dataset. For reference, the <code>syngrowth</code> synthetic data example packaged with <code>growthcleanr</code> takes 2-3 minutes to process on a contemporary laptop. <code>growthcleanr</code> uses optimized libraries (e.g. <code>data.table</code>) to go as fast as possible, but there are limits given the repeated passes over data required.</p>
<p>If you have under one million records, using <code>growthcleanr</code> may just necessitate planning to wait a little while the job processes. There are several strategies to improve performance you might consider:</p>
<ul>
<li>The built-in <code>parallel</code> option should take advantage of multiple CPU cores when your hardware allows.</li>
<li>Running <code>growthcleanr</code> on a machine with more CPU cores and more RAM can improve this further.</li>
<li>Verify that supporting libraries like <code>data.table</code> are <a href="#platform">installed properly</a> for your machine</li>
<li>Anecdotally, Windows users have sometimes seen slower performance when compared with similarly-appointed hardware running Linux or macOS.</li>
</ul>
<p>For very large datasets, on the order of millions of records or more, cleaning data can take several hours or more. When running this kind of job, the risk of failures due to external factors such as power outages increases. The current structure of <code>growthcleanr</code> does not checkpoint results as progress is made, so if a job has to run overnight and fails in the middle, a researcher would likely need to start over from scratch.</p>
<p>Because <code>growthcleanr</code> operates for the most part on individual subjects one at a time, however, this issue might be mitigated by splitting the input data into many small files, then running <code>growthcleanr</code> separately on each file, with results re-combined at the end. The primary benefit of this strategy would be the saving of the results of each file as it completes, allowing a researcher whose job fails overnight to resume processing on only the as yet incomplete input files. A secondary benefit might be a slight improvement of use of available RAM.</p>
<p>Adopting this approach might require some custom code, and there are few pitfalls to avoid. The following lays out a rough approach:</p>
<ul>
<li>Extract <code>sd.median</code> values for the entire dataset as a whole using the <code>sdmedian.filename</code> option. This is critical, as <code>growthcleanr</code> will generate these values itself for an input dataset if they are not provided. If a large dataset is split into 1,000 smaller files to be cleaned separately, each of those 1,000 <code>growthcleanr</code> jobs needs to use the same <code>sd.median</code> values to recenter or the results will be inconsistent. Pass this data in to <code><a href="../reference/cleangrowth.html">cleangrowth()</a></code> using the parameter <code>sd.recenter</code>.</li>
<li>Split the data into many small files, but keep each individual subject’s measurements together in one file. If, for example, a subject has 12 measurements, all 12 should be in one and only one of the smaller files to maximize the longitudinal analysis of their values. The <code><a href="../reference/splitinput.html">splitinput()</a></code> function will perform this split safely, e.g.:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">growthcleanr</span><span class="op">)</span>
<span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splitinput.html">splitinput</a></span><span class="op">(</span><span class="va">syngrowth</span>, fname <span class="op">=</span> <span class="st">"mydata"</span>, fdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">count</span></code></pre></div>
<pre><code>## [1] 8</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"mydata.*"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "mydata.00000.csv" "mydata.00001.csv" "mydata.00002.csv" "mydata.00003.csv"
## [5] "mydata.00004.csv" "mydata.00005.csv" "mydata.00006.csv" "mydata.00007.csv"
## [9] "mydata.00008.csv"</code></pre>
<ul>
<li>Use the standalone driver script <code>exec/gcdriver.R</code> to execute growthcleanr` on each separate file, then write out its results when complete. An example is below.</li>
<li>Invoke the job using a tool like <a href="https://www.gnu.org/software/parallel/">GNU Parallel</a>, which can be run on all major platforms. An example invocation is below as well.</li>
<li>If a failure occurs, set aside both the completed inputs and their results. Then re-run the job on only the remaining input data.</li>
<li>When complete, re-combine the data into one file or as otherwise appropriate.</li>
</ul>
<p>To invoke <code>gcdriver.R</code> on a single input file using <code>Rscript</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> Rscript gcdriver.R <span class="at">--quietly</span> <span class="at">--sdrecenter</span> sdmedians.csv mydata.csv mydata-cleaned.csv</span></code></pre></div>
<p>If you have many small files saved, for example, as <code>mydata.00001.csv</code>, <code>mydata.00002.csv</code>, etc., this driver can be invoked using <code>parallel</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%</span> ls mydata.<span class="pp">?????</span>.csv <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j2</span> <span class="at">--eta</span> <span class="dt">\</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rscript gcdriver.R --quietly --sdrecenter sdmedians.csv {} {}-clean"</span></span></code></pre></div>
<p>This lists your input files, and passes the filename list to parallel to use in invoking the driver script, one file at a time, and to process as parallel jobs as resources are available. Each run of the job then saves the cleaned output with <code>-clean</code> appended to the input filename, and as each completes, the next file on the list will be started until all are complete. A few things to note:</p>
<ul>
<li>The careful use of naming and wildcards when listing input files and naming output files can save accidental re-running of data from output files</li>
<li>The <code>-j2</code> option specifies running two jobs at once; <code>-j0</code> would use as many CPU cores as a machine has available. This might need to vary to match specific hardware.</li>
<li>The <code>--eta</code> option will report on progress.</li>
<li>The <code>--quietly</code> option on the driver script will make it easier to monitor progress with less verbose output coming from <code>growthcleanr</code>.</li>
<li>The <code>--sdrecenter</code> option on the driver script should be set to ensure each individual file is recentered using the same set for the entire input.</li>
<li>If multiple cores are available, the job should proceed with speedup roughly similar to what can be gained using the parallel batching feature built in to <code>growthcleanr</code>, with the main difference being the saving of intermediate output as each smaller file completes.</li>
</ul>
<p>If your data to be cleaned is very large, it might help to store it compressed, for example with <code>gzip</code> and its corresponding <code>.gz</code> filename extension. <code>growthcleanr</code> can read in <code>.gz</code> input, but you might need to install the <code>R.utils</code> package first. <code>R</code> will provide a message if this is required.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daymont Carrie, Grundmeier Robert, Miller Jeffrey, Campos Diego.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
