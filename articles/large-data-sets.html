<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with large data sets • growthcleanr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with large data sets">
<meta property="og:description" content="growthcleanr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">growthcleanr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Getting started</li>
    <li>
      <a href="../articles/quickstart.html">Quickstart</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/usage.html">Usage</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced topics</li>
    <li>
      <a href="../articles/configuration.html">Configuration</a>
    </li>
    <li>
      <a href="../articles/output.html">Understanding growthcleanr output</a>
    </li>
    <li>
      <a href="../articles/adult-algorithm.html">Adult algorithm</a>
    </li>
    <li>
      <a href="../articles/utilities.html">Utilities for computing pediatric BMI percentiles, Z-scores, and related tools</a>
    </li>
    <li>
      <a href="../articles/large-data-sets.html">Working with large data sets</a>
    </li>
    <li>
      <a href="../articles/next-steps.html">Next steps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/carriedaymont/growthcleanr" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="large-data-sets_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with large data sets</h1>
            
            <h4 data-toc-skip class="date">2022-08-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/carriedaymont/growthcleanr/blob/main/vignettes/large-data-sets.Rmd" class="external-link"><code>vignettes/large-data-sets.Rmd</code></a></small>
      <div class="hidden name"><code>large-data-sets.Rmd</code></div>

    </div>

    
    
<p>The nature of the <code>growthcleanr</code> algorithm is repetitive. It runs many checks over each individual subject’s measurements, in a specific sequence, and revises its assessments as it goes. Because of this, it can take some time to process even a modest dataset. For reference, the <code>syngrowth</code> synthetic data example packaged with <code>growthcleanr</code> takes 2-3 minutes to process on a contemporary laptop. <code>growthcleanr</code> uses optimized libraries (e.g. <code>data.table</code>) to go as fast as possible, but there are limits given the repeated passes over data required. If you have under one million records, using <code>growthcleanr</code> may just necessitate planning to wait a little while the job processes.</p>
<p>If you have a much larger dataset, there are several strategies to improve performance you might consider:</p>
<ul>
<li>The built-in <code><a href="../reference/cleangrowth.html">cleangrowth()</a></code> option <code>parallel</code> should take advantage of multiple CPU cores when your hardware allows.</li>
<li>Running <code>growthcleanr</code> on a machine with more CPU cores and more RAM can improve this further.</li>
<li>Verify that supporting libraries like <code>data.table</code> are <a href="installation.html">installed properly</a> for your machine</li>
<li>If you are cleaning very large datasets with several million observations or more, you might consider the techniques for splitting input and processing in parallel jobs described below.</li>
<li>If you are cleaning adult data, an in-memory data-splitting technique is implemented in the <code>gcdriver.R</code> script described below.</li>
<li>Anecdotally, Windows users have sometimes seen slower performance when compared with similarly-appointed hardware running Linux or macOS.</li>
</ul>
<div class="section level2">
<h2 id="splitting-input-datasets">Splitting input datasets<a class="anchor" aria-label="anchor" href="#splitting-input-datasets"></a>
</h2>
<p>For very large datasets, on the order of millions of records or more, cleaning data can take several hours or more. When running this kind of job, the risk of failures due to external factors such as power outages increases. The current structure of <code>growthcleanr</code> does not checkpoint results as progress is made, so if a job has to run overnight and fails in the middle, a researcher would likely need to start over from scratch.</p>
<p>Because <code>growthcleanr</code> operates for the most part on individual subjects one at a time, however, this issue might be mitigated by splitting the input data into many small files, then running <code>growthcleanr</code> separately on each file, with results re-combined at the end. The primary benefit of this strategy would be the saving of the results of each file as it completes, allowing a researcher whose job fails overnight to resume processing on only the as yet incomplete input files. A secondary benefit might be a slight improvement of use of available RAM.</p>
<p>Adopting this approach might require some custom code, and there are few pitfalls to avoid. The following lays out a rough approach:</p>
<ul>
<li>For cleaning pediatric data, ensure that <code>growthcleanr</code> uses a consistent set of recentering means for each run. This can be achieved a few ways, the simplest of which is to specify the <code><a href="../reference/cleangrowth.html">cleangrowth()</a></code> option <code>sd.recenter</code> as <code>"NHANES"</code>, which will use a built-in reference set of recentering means <a href="configuration.html#nhanes-reference-medians-1">derived from NHANES</a>. Another option is to run <code><a href="../reference/cleangrowth.html">cleangrowth()</a></code> once on your entire dataset to extract <code>sd.median</code> values for the entire dataset as a whole using the <code>sdmedian.filename</code> option. This would then create a recentering means file you could specify using <code>sd.recenter</code> on each run on a subset of your data. Either way, addressing this concern is critical, as <code>growthcleanr</code> will may otherwise generate these values itself for a large input dataset if they are not otherwise specified. In other words, if a large dataset is split into 1,000 smaller files to be cleaned separately, each of those 1,000 <code>growthcleanr</code> jobs needs to use the same <code>sd.median</code> values to recenter or the results will be inconsistent.</li>
<li>Split the data into many small files, but keep each individual subject’s measurements together in one file. If, for example, a subject has 12 measurements, all 12 should be in one and only one of the smaller files to maximize the longitudinal analysis of their values. The <code><a href="../reference/splitinput.html">splitinput()</a></code> function will perform this split safely, e.g.:</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://carriedaymont.github.io/growthcleanr/index.html" class="external-link">growthcleanr</a></span><span class="op">)</span></span>
<span><span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splitinput.html">splitinput</a></span><span class="op">(</span><span class="va">syngrowth</span>, fname <span class="op">=</span> <span class="st">"mydata"</span>, fdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">count</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 7</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"mydata.*"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mydata.00000.csv" "mydata.00001.csv" "mydata.00002.csv" "mydata.00003.csv"</span></span>
<span><span class="co">## [5] "mydata.00004.csv" "mydata.00005.csv" "mydata.00006.csv" "mydata.00007.csv"</span></span></code></pre>
<ul>
<li>Use the standalone driver script <code>exec/gcdriver.R</code> to execute growthcleanr` on each separate file, then write out its results when complete. An example is below.</li>
<li>Invoke the job using a tool like <a href="https://www.gnu.org/software/parallel/" class="external-link">GNU Parallel</a>, which can be run on all major platforms. An example invocation is below as well.</li>
<li>If a failure occurs, set aside both the completed inputs and their results. Then re-run the job on only the remaining input data.</li>
<li>When complete, re-combine the data into one file or as otherwise appropriate.</li>
</ul>
<p>To invoke <code>exec/gcdriver.R</code> on a single input file using <code>Rscript</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">Rscript</span> exec/gcdriver.R --quietly --sdrecenter nhanes mydata.csv mydata-cleaned.csv</span></code></pre></div>
<p>If you have many small files saved, for example, as <code>mydata.00001.csv</code>, <code>mydata.00002.csv</code>, etc., this driver can be invoked using <code>parallel</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">%</span> ls mydata.?????.csv <span class="kw">|</span> <span class="ex">parallel</span> -j2 --eta \</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="st">"Rscript exec/gcdriver.R --quietly --sdrecenter nhanes {} {}-clean.csv"</span></span></code></pre></div>
<p>This lists your input files, and passes the filename list to parallel to use in invoking the driver script, one file at a time, and to process as parallel jobs as resources are available. Each run of the job then saves the cleaned output with <code>-clean.csv</code> appended to the input filename, and as each completes, the next file on the list will be started until all are complete. A few things to note:</p>
<ul>
<li>The careful use of naming and wildcards when listing input files and naming output files can save accidental re-running of data from output files</li>
<li>The <code>-j2</code> option specifies running two jobs at once; <code>-j0</code> would use as many CPU cores as a machine has available. This might need to vary to match specific hardware.</li>
<li>The <code>--eta</code> option will report on progress.</li>
<li>The <code>--quietly</code> option on the driver script will make it easier to monitor progress with less verbose output coming from <code>growthcleanr</code>.</li>
<li>The <code>--sdrecenter</code> option on the driver script should be set to ensure each individual file is recentered using the same set for the entire input. This example uses the built-in <a href="configuration.html#nhanes-reference-medians-1">NHANES reference set</a>; you could substitute your own.</li>
<li>If multiple cores are available, the job should proceed with speedup roughly similar to what can be gained using the parallel batching feature built in to <code>growthcleanr</code>, with the main difference being the saving of intermediate output as each smaller file completes.</li>
</ul>
<p>If your data to be cleaned is very large, it might help to store it compressed, for example with <code>gzip</code> and its corresponding <code>.gz</code> filename extension. <code>growthcleanr</code> can read in <code>.gz</code> input, but you might need to install the <code>R.utils</code> package first. <code>R</code> will provide a message if this is required.</p>
</div>
<div class="section level2">
<h2 id="batch-splitting-for-adult-data">Batch splitting for adult data<a class="anchor" aria-label="anchor" href="#batch-splitting-for-adult-data"></a>
</h2>
<p>The <a href="adult-algorithm.html">adult algorithm</a> is new as of release 2.0.0 and may require further optimization to improve speed performance. Testing discovered that performing an inline data split (as opposed to physically splitting the data into many small input sets and processing each separately, as described above) can gain substantial performance on a single machine with many cores available. Two options to the <code>exec/gcdriver.R</code> script take advantage of this performance improvement.</p>
<p>The following example may be used on a large dataset of adult data.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">Rscript</span> exec/gcdriver.R --numbatches 4 --adult_split 50 my-large-input.csv my-large-input-cleaned.csv</span></code></pre></div>
<ul>
<li>
<code>--numbatches 4</code> may be a good starting point for testing on a desktop-class machine with four virtual cores.</li>
<li>
<code>--adult_split 50</code> will divide the input set into 50 smaller subsets, keeping all records for individual subjects together</li>
</ul>
<p>You may find that adjusting these numbers to take advantage of your available hardware can make a difference in overall run time.</p>
</div>
<div class="section level2">
<h2 id="reference-for-gcdriver-r">Reference for <code>gcdriver.R</code><a class="anchor" aria-label="anchor" href="#reference-for-gcdriver-r"></a>
</h2>
<p>All available options for <code>gcdriver.R</code> are described below.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">Rscript</span> exec/gcdriver.R --help</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">usage</span>: gcdriver.R [--] [--help] [--quietly] [--opts OPTS] [--sdrecenter</span>
<span id="cb8-3"><a href="#cb8-3"></a>       <span class="ex">SDRECENTER</span>] [--adult_cutpoint ADULT_CUTPOINT] [--weightcap</span>
<span id="cb8-4"><a href="#cb8-4"></a>       <span class="ex">WEIGHTCAP</span>] [--numbatches NUMBATCHES] [--adult_split ADULT_SPLIT]</span>
<span id="cb8-5"><a href="#cb8-5"></a>       <span class="ex">infile</span> outfile</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="ex">CLI</span> driver for growthcleanr</span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="ex">positional</span> arguments:</span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="ex">infile</span>                input file</span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="ex">outfile</span>               output file</span>
<span id="cb8-12"><a href="#cb8-12"></a></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="ex">flags</span>:</span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="ex">-h</span>, --help            show this help message and exit</span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="ex">-q</span>, --quietly         Disable verbose output</span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="ex">optional</span> arguments:</span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="ex">-x</span>, --opts            RDS file containing argument values</span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="ex">-s</span>, --sdrecenter      sd.recenter data file [default: ]</span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="ex">-a</span>, --adult_cutpoint  adult cutpoint [default: 20]</span>
<span id="cb8-21"><a href="#cb8-21"></a>  <span class="ex">-w</span>, --weightcap       weight cap [default: Inf]</span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="ex">-n</span>, --numbatches      Number of batches [default: 1]</span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="ex">--adult_split</span>         Number of splits to run data on [default: Inf]</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daymont Carrie, Grundmeier Robert, Miller Jeffrey, Campos Diego, De los Santos Hannah.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
